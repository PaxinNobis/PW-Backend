Prompt para el Backend de AstroTV (Node.js + Prisma)
1. Misi贸n

Construir el servidor backend y la API para la plataforma de streaming "AstroTV". El backend debe manejar la autenticaci贸n de usuarios (espectadores y creadores), la gesti贸n de datos (streams, juegos, tags), las interacciones sociales (seguimiento), el chat en tiempo real, el panel de control del creador (anal铆ticas, regalos, niveles) y la pasarela de pagos para comprar monedas.

2. Stack Tecnol贸gico

Servidor: Node.js con Express

Base de Datos: PostgreSQL (o MySQL/SQLite)

ORM: Prisma

Autenticaci贸n: JWT (JSON Web Tokens) y bcryptjs (para hasheo de contrase帽as)

Tiempo Real (Chat): WebSockets (usando la librer铆a ws)

3. Modelo de Datos (Esquema de Prisma)

Este es el archivo prisma/schema.prisma. Est谩 basado en tus archivos de frontend como types/auth.ts, GlobalObjects/Objects_DataTypes.tsx, GestionRegalos.tsx y ConfiguracionNiveles.tsx.

Fragmento de c贸digo
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Puedes cambiar esto a mysql o sqlite
  url      = env("DATABASE_URL")
}

// Modelo de Usuario (basado en types/auth.ts)
model User {
  id     String   @id @default(uuid())
  email  String   @unique
  name   String
  password String // Contrase帽a hasheada
  role   UserRole @default(VIEWER)

  // --- Datos de Espectador ---
  level  Int? // Nivel de espectador (RF010)
  points Int? // Puntos acumulados (RF010)
  coins  Int? // Saldo de monedas (RF009)

  // --- Relaciones de Streamer ---
  stream           Stream? // Un usuario (streamer) tiene un stream
  analytics        Analytics? // Anal铆ticas del streamer
  customGifts      Gift[] // Regalos personalizados del streamer
  loyaltyLevels    LoyaltyLevel[] // Niveles de lealtad del streamer
  receivedMessages ChatMessage[] @relation("ChatMessages") // Mensajes recibidos en su chat

  // --- Relaciones Sociales y de Chat ---
  following    User[]        @relation("UserFollows") // A qui茅n sigue este usuario
  followedBy   User[]        @relation("UserFollows") // Qui茅n sigue a este usuario
  sentMessages ChatMessage[] @relation("SentMessages") // Mensajes que este usuario env铆a

  @@map("users")
}

// Modelo de Stream (basado en Objects_DataTypes.tsx)
model Stream {
  id          String   @id @default(uuid())
  title       String
  thumbnail   String
  viewers     Int      @default(0)
  isLive      Boolean  @default(false)
  
  streamer    User     @relation(fields: [streamerId], references: [id])
  streamerId  String   @unique // Un stream pertenece a un solo User
  
  game        Game     @relation(fields: [gameId], references: [id])
  gameId      String
  
  tags        Tag[]    @relation("StreamTags")
  chatMessages ChatMessage[]

  @@map("streams")
}

// Modelo de Juego (basado en Objects_DataTypes.tsx)
model Game {
  id      String   @id @default(uuid())
  name    String   @unique
  photo   String
  streams Stream[]
  tags    Tag[]    @relation("GameTags") // Tags asociados al juego

  @@map("games")
}

// Modelo de Tag (basado en Objects_DataTypes.tsx)
model Tag {
  id      String   @id @default(uuid())
  name    String   @unique
  streams Stream[] @relation("StreamTags")
  games   Game[]   @relation("GameTags")

  @@map("tags")
}

// Modelo de Mensaje de Chat (basado en ChatMessage.tsx)
model ChatMessage {
  id        String   @id @default(uuid())
  text      String
  createdAt DateTime @default(now())
  
  // A qu茅 stream pertenece
  stream    Stream   @relation(fields: [streamId], references: [id])
  streamId  String
  
  // Qui茅n envi贸 el mensaje
  author    User     @relation("SentMessages", fields: [authorId], references: [id])
  authorId  String

  // A qu茅 chat pertenece (el chat del streamer due帽o)
  streamOwner User   @relation("ChatMessages", fields: [streamOwnerId], references: [id])
  streamOwnerId String

  @@map("chat_messages")
}

// --- Modelos del Panel de Creador ---

// Para Analiticas.tsx
model Analytics {
  id                 String  @id @default(uuid())
  horasTransmitidas  Float   @default(0)
  monedasRecibidas   Int     @default(0)
  
  streamer    User   @relation(fields: [streamerId], references: [id])
  streamerId  String @unique

  @@map("analytics")
}

// Para GestionRegalos.tsx
model Gift {
  id        String   @id @default(uuid())
  nombre    String
  costo     Int // Costo en DogeCoins
  puntos    Int // Puntos que otorga
  
  streamer  User     @relation(fields: [streamerId], references: [id])
  streamerId String

  @@map("gifts")
}

// Para ConfiguracionNiveles.tsx y FilaNivel.tsx
model LoyaltyLevel {
  id               String   @id @default(uuid())
  nombre           String
  puntosRequeridos Int
  recompensa       String
  
  streamer   User   @relation(fields: [streamerId], references: [id])
  streamerId String

  @@map("loyalty_levels")
}

// --- Modelos para Pagos ---

// Para PackMonedas.tsx y CardMoneda.tsx
model CoinPack {
  id       String @id @default(uuid())
  nombre   String // Ej: "Starter pack"
  valor    Int // Cantidad de DogeCoins (ej: 30)
  en_soles Float  // Precio en PEN (ej: 1.50)

  @@map("coin_packs")
}

// --- Enums ---

enum UserRole {
  VIEWER
  STREAMER
}
4. Definici贸n de Endpoints de API (Rutas de Express)

Necesitar谩s crear estas rutas para dar servicio a tu frontend.

M贸dulo de Autenticaci贸n (/api/auth)

POST /register: (Para Signup.tsx) Registra un nuevo User. Debe hashear la contrase帽a con bcryptjs.

POST /login: (Para Login.tsx y auth.service.ts) Autentica un User, compara la contrase帽a hasheada y devuelve un jsonwebtoken.

GET /me: (Ruta protegida por middleware JWT) (Para AuthContext.tsx) Devuelve los datos del usuario autenticado (req.user).

M贸dulo de Datos P煤blicos (/api/data)

GET /streams: (Para App.tsx y Home.tsx) Devuelve una lista de todos los Stream, incluyendo sus relaciones streamer y game.

GET /tags: (Para ExploreTags.tsx) Devuelve todos los Tag.

GET /games: (Para ExploreGames.tsx) Devuelve todos los Game.

GET /streams/details/:nickname: (Para Streaming.tsx) Devuelve los datos de un Stream espec铆fico basado en el nickname del streamer.

GET /search/:query: (Para Search.tsx y SearchBar.tsx) Busca streams por title o por streamer.nickname.

M贸dulo de Usuario (/api/user) - (Rutas Protegidas)

GET /following: (Para App.tsx y SideBar.tsx) Devuelve la lista de User que el usuario actual sigue.

POST /follow/:streamerId: (Para FollowButton.tsx) A帽ade o quita un User (streamer) de la lista following del usuario actual.

POST /become-creator: (Para ConvertirseCreador.tsx) Actualiza el role del usuario de VIEWER a STREAMER.

M贸dulo de Pagos (/api/payment) - (Rutas Protegidas)

GET /coin-packs: (Para PackMonedas.tsx) Devuelve la lista de CoinPack disponibles para comprar.

POST /create-checkout-session: (Para PasarelaPago.tsx) Importante: Integra una pasarela de pago (ej. Stripe). Este endpoint recibe el coinPackId, crea una sesi贸n de pago en la pasarela y devuelve al frontend la URL de pago o el ID de sesi贸n.

POST /webhook: (Para el servicio de la pasarela) Endpoint que recibe la confirmaci贸n de un pago exitoso desde la pasarela. Al recibirla, busca al User y actualiza su campo coins.

M贸dulo del Panel de Creador (/api/panel) - (Protegido y con role === 'STREAMER')

GET /analytics: (Para Analiticas.tsx) Devuelve el Analytics del streamer.

GET /gifts: (Para GestionRegalos.tsx) Devuelve la lista de Gift del streamer.

POST /gifts: (Para GestionRegalos.tsx) Crea un nuevo Gift para el streamer.

PUT /gifts/:id: Edita un Gift.

DELETE /gifts/:id: Elimina un Gift.

GET /loyalty-levels: (Para ConfiguracionNiveles.tsx) Devuelve la lista de LoyaltyLevel del streamer.

PUT /loyalty-levels: (Para ConfiguracionNiveles.tsx) Recibe un array de niveles y los actualiza/crea/elimina.

5. L贸gica del Chat (Servidor de WebSockets)

Esto se maneja con la librer铆a ws, no con Express.

Iniciar Servidor WS: Inicia un WebSocketServer junto con tu servidor Express.

Manejar Conexi贸n (wss.on('connection', ...)):

El cliente (desde Streaming.tsx) debe enviar un mensaje de "join" con su token (JWT) y el streamerNickname del chat al que se une.

Valida el token y obt茅n el userId y name del usuario.

Busca el streamId basado en el streamerNickname.

Suscribe el WebSocket (conexi贸n) a una "sala" (que puedes manejar con un Map, ej: Map<streamId, Set<WebSocket>>).

Manejar Mensajes (ws.on('message', ...)):

Cuando el cliente (desde ChatBar.tsx) env铆a un mensaje de chat (ej: { type: 'chat', text: 'Hola!' }):

Obt茅n el streamId al que est谩 suscrito este ws.

Guardar en DB: Crea una nueva entrada en ChatMessage en Prisma, ligada al streamId y al authorId (del usuario).

Broadcast: Reenv铆a el mensaje guardado (que ahora tiene id, text, createdAt, author.name) a todos los WebSocket en la sala (el Set<WebSocket> de ese streamId).

Manejar Desconexi贸n (ws.on('close', ...)):

Elimina el WebSocket de la sala en el Map para que no reciba m谩s mensajes.

6. Archivo Inicial (src/index.ts)

TypeScript
import express from 'express';
import cors from 'cors';
import http from 'http';
import { WebSocketServer } from 'ws';
import { PrismaClient } from '@prisma/client';

// Importa tus middlewares
// import { authMiddleware } from './middleware/auth.middleware';

// Importa tus rutas
// import authRoutes from './routes/auth.routes';
// import dataRoutes from './routes/data.routes';
// import userRoutes from './routes/user.routes';
// import panelRoutes from './routes/panel.routes';
// import paymentRoutes from './routes/payment.routes';

// Importa tu l贸gica de WebSocket
// import { handleWebSocketConnection } from './services/websocket.service';

const app = express();
const server = http.createServer(app);
const wss = new WebSocketServer({ server });

export const prisma = new PrismaClient();

// Middlewares globales de Express
app.use(cors());
app.use(express.json());

// --- Rutas de API ---
// app.use('/api/auth', authRoutes);
// app.use('/api/data', dataRoutes);
// app.use('/api/user', authMiddleware, userRoutes); // Protegida
// app.use('/api/panel', authMiddleware, /* streamerRoleMiddleware, */ panelRoutes); // Doble protecci贸n
// app.use('/api/payment', authMiddleware, paymentRoutes); // Protegida

// --- Servidor WebSocket ---
// wss.on('connection', handleWebSocketConnection);

// --- Iniciar Servidor ---
const PORT = process.env.PORT || 8080;
server.listen(PORT, () => {
  console.log(` Servidor HTTP y WebSocket corriendo en http://localhost:${PORT}`);
});